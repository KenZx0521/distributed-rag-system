# 分散式 RAG 系統專案架構規劃

## 專案概述
本專案旨在構建一個分散式 RAG 系統，使用者可提交查詢任務（例如問答或文本生成），系統透過多個計算節點執行檢索與生成任務。RAG 系統結合檢索模組（從知識庫檢索相關資料）與生成模組（基於檢索結果生成回答）。系統提供 Web 介面，讓使用者提交任務、監控任務狀態（完成、執行中、排隊中）並刪除未執行任務。

---

## 系統需求
1. **提供計算服務**：執行 RAG 任務，包含檢索（Retrieval）和生成（Generation）。
2. **至少三個計算節點**：分散式處理任務，支援負載平衡與容錯。
3. **允許刪除未執行任務**：使用者可透過 Web 介面取消排隊中的任務。
4. **Web 版工作管理員**：提供直觀介面，支援任務提交、狀態查詢與管理。
5. **任務狀態監控**：顯示完成、執行中（標示執行節點）、排隊中的任務數量與詳情。

---

## 系統架構
系統分為以下主要模組：前端（Web 介面）、後端（API 與任務調度）、計算節點（執行 RAG 任務）、資料庫（儲存任務與知識庫資料）、訊息佇列（任務分發）。

### 1. 前端（Web 介面）
- **功能**：
  - 任務提交：使用者輸入查詢（如問題或生成需求）並提交。
  - 任務管理：顯示任務列表（ID、狀態、執行節點、提交時間等），支援取消排隊中的任務。
  - 狀態監控：即時顯示任務統計（完成、執行中、排隊中）與節點分配。
  - 結果檢視：顯示完成的任務結果（生成的回答或檢索的資料）。
- **框架與工具**：
  - **React**：構建動態、組件化的前端介面。
  - **Tailwind CSS**：快速實現響應式、現代化的 UI 設計。
  - **Axios**：處理與後端 API 的 HTTP 請求。
  - **Recharts**：繪製任務狀態圖表（如節點負載、任務分佈）。
  - **WebSocket**（或定時輪詢）：實現任務狀態的即時更新。
- **設計考慮**：
  - 使用單頁應用（SPA）結構，提升使用者體驗。
  - 提供分頁與篩選功能，方便管理大量任務。

### 2. 後端（API 與任務調度）
- **功能**：
  - 接收前端任務請求，存入訊息佇列。
  - 管理任務生命週期（提交、排隊、執行、完成）。
  - 提供 API 查詢任務狀態與結果，支援任務刪除。
  - 與計算節點通信，分配任務並收集結果。
- **框架與工具**：
  - **FastAPI**（Python）：高效的非同步 API 框架，適合快速開發與高併發。
  - **Celery**：任務調度與分發，支援分散式任務管理。
  - **RabbitMQ**：訊息佇列，作為任務分發與節點通信的中介。
  - **PostgreSQL**：儲存任務元資料（ID、狀態、節點、結果等）。
  - **Redis**：作為快取與臨時任務佇列，提升性能。
- **設計考慮**：
  - API 採用 RESTful 設計，支援任務的 CRUD 操作。
  - 使用非同步處理（FastAPI）提升 API 響應速度。
  - 任務調度器支援優先級與負載平衡，確保節點資源充分利用。

### 3. 計算節點（RAG 任務執行）
- **功能**：
  - 執行 RAG 任務：檢索相關資料（使用向量資料庫）並生成回答（使用語言模型）。
  - 接收任務（透過訊息佇列），回傳結果至後端。
  - 報告節點狀態（如 CPU/GPU 使用率、任務進度）。
- **框架與工具**：
  - **Python**：作為主要開發語言，支援 RAG 核心功能。
  - **LangChain** 或 **LlamaIndex**：實現 RAG 流程（檢索 + 生成）。
  - **FAISS** 或 **Pinecone**：作為向量資料庫，儲存與檢索知識庫 embedding。
  - **Hugging Face Transformers** 或 **vLLM**：執行生成任務（如基於 LLaMA 或 BERT 的模型）。
  - **Docker**：封裝節點程式，確保環境一致性。
  - **Kubernetes**（可選）：管理多節點部署，支援動態擴展。
- **設計考慮**：
  - 至少部署三個節點，每個節點獨立執行 RAG 任務。
  - 支援 GPU 加速（若可用），提升生成效率。
  - 節點定期向後端報告狀態，確保監控準確性。

### 4. 知識庫
- **功能**：
  - 儲存結構化與非結構化資料（文本、PDF 等），供檢索模組使用。
  - 支援動態更新，允許新增或修改知識庫內容。
- **工具**：
  - **FAISS**：本地向量資料庫，適合快速原型開發。
  - **Pinecone**（可選）：雲端向量資料庫，支援高可用性與擴展。
  - **Elasticsearch**（可選）：輔助檢索結構化資料或關鍵字搜索。
- **設計考慮**：
  - 知識庫資料預先轉換為 embedding，儲存於向量資料庫。
  - 提供 API 供後端更新知識庫內容。

### 5. 訊息佇列
- **功能**：
  - 管理任務分發，確保任務可靠傳遞至計算節點。
  - 支援任務取消（移除排隊中的任務）。
- **工具**：
  - **RabbitMQ**：可靠的訊息佇列系統，支援高併發與容錯。
  - **Redis**（輔助）：作為輕量級佇列或快取。
- **設計考慮**：
  - 每個任務分配唯一的 ID，確保可追蹤與管理。
  - 支援任務優先級，允許緊急任務優先執行。

### 6. 資料庫
- **功能**：
  - 儲存任務元資料（ID、狀態、節點、提交時間、結果等）。
  - 記錄節點狀態（活躍、負載等）。
- **工具**：
  - **PostgreSQL**：關聯式資料庫，適合結構化資料。
  - **Redis**：作為快取，儲存即時任務狀態。
- **設計考慮**：
  - 設計高效的資料表結構，支援快速查詢。
  - 定期清理過期任務資料，優化儲存空間。

---

## 架構圖
```
[前端: React + Tailwind CSS]
       ↕ (REST API / WebSocket)
[後端: FastAPI + Celery]
       ↕ (任務元資料)
[資料庫: PostgreSQL + Redis]
       ↕ (任務分發)
[訊息佇列: RabbitMQ]
       ↕ (任務執行)
[計算節點 1: LangChain + FAISS + Transformers]
[計算節點 2: LangChain + FAISS + Transformers]
[計算節點 3: LangChain + FAISS + Transformers]
       ↕ (知識庫檢索)
[知識庫: FAISS / Pinecone]
```

---

## 工具與框架總結
### 前端
- **框架**：React
- **樣式**：Tailwind CSS
- **HTTP 客戶端**：Axios
- **圖表**：Recharts
- **即時更新**：WebSocket 或定時輪詢

### 後端
- **API 框架**：FastAPI
- **任務調度**：Celery
- **訊息佇列**：RabbitMQ
- **資料庫**：PostgreSQL、Redis

### 計算節點
- **語言**：Python
- **RAG 框架**：LangChain 或 LlamaIndex
- **檢索**：FAISS 或 Pinecone
- **生成**：Hugging Face Transformers 或 vLLM
- **容器化**：Docker
- **叢集管理**：Kubernetes（可選）

### 知識庫
- **向量資料庫**：FAISS 或 Pinecone
- **輔助檢索**：Elasticsearch（可選）

---

## 設計考慮與擴展性
1. **負載平衡**：Celery 與 RabbitMQ 確保任務均勻分發，Kubernetes 可動態調整節點數量。
2. **容錯性**：任務失敗時自動重試，節點故障時重新分配任務。
3. **安全性**：API 使用 JWT 認證，保護任務資料；知識庫資料加密儲存。
4. **擴展性**：支援新增計算節點與知識庫分片，適應更大規模任務。
5. **監控與日誌**：整合 Prometheus + Grafana 監控節點性能，ELK Stack 記錄系統日誌。

---

## 下一步
- 定義 API 規格（OpenAPI）與資料庫結構。
- 實現最小可行產品（MVP），包含單節點 RAG 功能與基本 Web 介面。
- 測試多節點部署，驗證任務分發與狀態監控。